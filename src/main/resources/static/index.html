<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash Recipe - –°–±–æ—Ä–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .ingredients-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 0;
        }

        .deck-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 0;
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .ingredients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
            contain: layout;
        }

        .deck-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            min-height: 200px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
            border: 2px dashed #ccc;
            contain: layout;
        }

        .ingredient-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 2px solid transparent;
            position: relative;
            user-select: none;
            will-change: transform;
            contain: layout style paint;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .ingredient-card:hover:not(.dragging) {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .ingredient-card:active {
            cursor: grabbing;
        }

        .ingredient-card.dragging {
            opacity: 0.3;
            transition: none;
            pointer-events: none;
            z-index: 1000;
        }

        .ingredient-card.rarity-COMMON {
            border-color: #9e9e9e;
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
        }

        .ingredient-card.rarity-UNCOMMON {
            border-color: #4caf50;
            background: linear-gradient(135deg, #c8e6c9 0%, #81c784 100%);
        }

        .ingredient-card.rarity-RARE {
            border-color: #2196f3;
            background: linear-gradient(135deg, #bbdefb 0%, #64b5f6 100%);
        }

        .ingredient-card.rarity-LEGENDARY {
            border-color: #ff9800;
            background: linear-gradient(135deg, #ffe0b2 0%, #ffb74d 100%);
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }

        .ingredient-card.rarity-MYTHIC {
            border-color: #9c27b0;
            background: linear-gradient(135deg, #e1bee7 0%, #ba68c8 100%);
            box-shadow: 0 0 10px rgba(156, 39, 176, 0.5);
        }

        .ingredient-card.new-unlocked {
            animation: unlockAnimation 1s ease-out;
        }

        .ingredient-card.new-unlocked.rarity-RARE {
            box-shadow: 0 0 50px rgba(33, 150, 243, 0.8) !important;
        }

        .ingredient-card.new-unlocked.rarity-MYTHIC {
            box-shadow: 0 0 60px rgba(156, 39, 176, 0.9) !important;
        }

        .ingredient-card.new-unlocked.rarity-LEGENDARY {
            box-shadow: 0 0 60px rgba(255, 152, 0, 0.9) !important;
        }

        @keyframes unlockAnimation {
            0% {
                opacity: 0;
                transform: scale(0.3) rotateY(180deg) translateY(-50px);
                filter: blur(10px);
            }
            30% {
                opacity: 0.7;
                filter: blur(5px);
            }
            50% {
                transform: scale(1.15) rotateY(90deg) translateY(0);
                filter: blur(0);
            }
            70% {
                transform: scale(0.98) rotateY(45deg);
            }
            85% {
                transform: scale(1.02) rotateY(-10deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotateY(0deg) translateY(0);
                filter: blur(0);
            }
        }

        .ingredient-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #333;
        }

        .ingredient-rarity {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
        }

        .ingredient-allergy {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
        }

        .deck-slot {
            aspect-ratio: 1;
            background: white;
            border: 2px dashed #999;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            transition: background 0.2s ease, border-color 0.2s ease;
            contain: layout;
        }

        .deck-slot.drag-over {
            background: #e3f2fd;
            border-color: #2196f3;
            border-style: solid;
        }

        .deck-slot.filled {
            border-style: solid;
            border-color: #4caf50;
        }

        .deck-count {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .deck-count.full {
            color: #f44336;
            font-weight: bold;
        }

        .button-container {
            text-align: center;
            margin-top: 20px;
        }

        .get-recipes-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .get-recipes-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0,0,0,0.4);
        }

        .get-recipes-btn:active {
            transform: translateY(0);
        }

        .get-recipes-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .unlock-random-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-bottom: 15px;
        }

        .unlock-random-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0,0,0,0.4);
        }

        .unlock-random-btn:active {
            transform: translateY(0);
        }

        .unlock-random-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .ingredients-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title-with-button {
            flex: 1;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .recipes-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 20px;
            display: none;
        }

        .recipes-section.visible {
            display: block;
        }

        .recipe-card {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .recipe-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .recipe-difficulty {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .recipe-difficulty.EASY {
            background: #4caf50;
            color: white;
        }

        .recipe-difficulty.MEDIUM {
            background: #ff9800;
            color: white;
        }

        .recipe-difficulty.HARD {
            background: #f44336;
            color: white;
        }

        .recipe-description {
            color: #666;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üç≥ Clash Recipe</h1>
        
        <div class="main-content">
            <div class="ingredients-section">
                <div class="ingredients-header">
                    <h2 class="section-title section-title-with-button">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h2>
                    <button class="unlock-random-btn" id="unlockRandomBtn">üé≤ –û—Ç–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</button>
                </div>
                <div class="ingredients-grid" id="ingredientsGrid">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤...</div>
                </div>
            </div>

            <div class="deck-section">
                <h2 class="section-title">–ö–æ–ª–æ–¥–∞ (–¥–æ 8)</h2>
                <div class="deck-grid" id="deckGrid"></div>
                <div class="deck-count" id="deckCount">0 / 8</div>
            </div>
        </div>

        <div class="button-container">
            <button class="get-recipes-btn" id="getRecipesBtn" disabled>–ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã</button>
        </div>

        <div class="recipes-section" id="recipesSection">
            <h2 class="section-title">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã</h2>
            <div id="recipesContainer"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000';
        let ingredients = [];
        let deck = [];
        let previousIngredientIds = new Set();

        const ingredientsGrid = document.getElementById('ingredientsGrid');
        const deckGrid = document.getElementById('deckGrid');
        const deckCount = document.getElementById('deckCount');
        const getRecipesBtn = document.getElementById('getRecipesBtn');
        const recipesSection = document.getElementById('recipesSection');
        const recipesContainer = document.getElementById('recipesContainer');

        function initDeck() {
            deckGrid.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const slot = document.createElement('div');
                slot.className = 'deck-slot';
                slot.dataset.slotIndex = i;
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('drop', handleDrop);
                slot.addEventListener('dragleave', handleDragLeave);
                deckGrid.appendChild(slot);
            }
        }

        function createIngredientCard(ingredient) {
            const card = document.createElement('div');
            card.className = `ingredient-card rarity-${ingredient.rarity}`;
            card.draggable = true;
            card.dataset.ingredientId = ingredient.id;
            
            const name = document.createElement('div');
            name.className = 'ingredient-name';
            name.textContent = ingredient.name;
            
            const rarity = document.createElement('div');
            rarity.className = 'ingredient-rarity';
            rarity.textContent = ingredient.rarity;
            
            card.appendChild(name);
            card.appendChild(rarity);
            
            if (ingredient.allergy) {
                const allergyBadge = document.createElement('div');
                allergyBadge.className = 'ingredient-allergy';
                allergyBadge.textContent = '!';
                card.appendChild(allergyBadge);
            }
            
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            
            return card;
        }

        function loadIngredients() {
            fetch(`${API_BASE}/ingredients/getUnlockedCards`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
                    console.log('–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:', typeof data);
                    console.log('–Ø–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:', Array.isArray(data));
                    
                    let ingredientsList = data;
                    if (!Array.isArray(data)) {
                        if (data && Array.isArray(data.body)) {
                            ingredientsList = data.body;
                        } else if (data && Array.isArray(data.data)) {
                            ingredientsList = data.data;
                        } else {
                            console.error('–û–∂–∏–¥–∞–ª—Å—è –º–∞—Å—Å–∏–≤, –ø–æ–ª—É—á–µ–Ω–æ:', data);
                            throw new Error('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º');
                        }
                    }
                    
                    const currentIngredientIds = new Set(ingredientsList.map(ing => ing.id));
                    const newIngredientIds = new Set();
                    
                    ingredientsList.forEach(ingredient => {
                        if (!previousIngredientIds.has(ingredient.id)) {
                            newIngredientIds.add(ingredient.id);
                        }
                    });
                    
                    ingredients = ingredientsList;
                    ingredientsGrid.innerHTML = '';
                    if (ingredients.length === 0) {
                        ingredientsGrid.innerHTML = '<div class="loading">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    } else {
                        ingredients.forEach((ingredient, index) => {
                            const card = createIngredientCard(ingredient);
                            if (newIngredientIds.has(ingredient.id)) {
                                card.classList.add('new-unlocked');
                                setTimeout(() => {
                                    card.style.animationDelay = `${index * 0.05}s`;
                                }, 10);
                                setTimeout(() => {
                                    card.classList.remove('new-unlocked');
                                }, 1000);
                            }
                            ingredientsGrid.appendChild(card);
                        });
                    }
                    
                    previousIngredientIds = currentIngredientIds;
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤:', error);
                    ingredientsGrid.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: ${error.message}</div>`;
                });
        }

        let draggedElement = null;
        let draggedIngredient = null;

        function handleDragStart(e) {
            draggedElement = e.target;
            const ingredientId = parseInt(e.target.dataset.ingredientId);
            draggedIngredient = ingredients.find(ing => ing.id === ingredientId);
            e.dataTransfer.effectAllowed = 'move';
            
            requestAnimationFrame(() => {
                draggedElement.classList.add('dragging');
            });
        }

        function handleDragEnd(e) {
            requestAnimationFrame(() => {
                e.target.classList.remove('dragging');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (e.target.classList.contains('deck-slot')) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            if (!draggedIngredient) return;
            
            const slotIndex = parseInt(e.target.dataset.slotIndex);
            
            if (isNaN(slotIndex)) return;
            
            if (deck.length >= 8) {
                alert('–ö–æ–ª–æ–¥–∞ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ (–º–∞–∫—Å–∏–º—É–º 8 –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤)');
                return;
            }
            
            if (deck.find(ing => ing.id === draggedIngredient.id)) {
                alert('–≠—Ç–æ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç —É–∂–µ –≤ –∫–æ–ª–æ–¥–µ');
                return;
            }
            
            deck.push(draggedIngredient);
            updateDeck();
            updateGetRecipesButton();
        }

        function updateDeck() {
            const slots = deckGrid.querySelectorAll('.deck-slot');
            slots.forEach((slot, index) => {
                if (deck[index]) {
                    if (!slot.querySelector('.ingredient-card')) {
                        const ingredient = deck[index];
                        const card = createIngredientCard(ingredient);
                        card.draggable = false;
                        card.style.cursor = 'default';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = '√ó';
                        removeBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 1.2em;';
                        removeBtn.addEventListener('click', () => {
                            deck.splice(index, 1);
                            updateDeck();
                            updateGetRecipesButton();
                        });
                        
                        card.style.position = 'relative';
                        card.appendChild(removeBtn);
                        slot.appendChild(card);
                        slot.classList.add('filled');
                    }
                } else {
                    if (slot.querySelector('.ingredient-card')) {
                        slot.innerHTML = '';
                        slot.classList.remove('filled');
                    }
                }
            });
            
            deckCount.textContent = `${deck.length} / 8`;
            deckCount.classList.toggle('full', deck.length >= 8);
        }

        function updateGetRecipesButton() {
            getRecipesBtn.disabled = deck.length === 0;
        }

        function getRecipes() {
            if (deck.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤ –∫–æ–ª–æ–¥—É');
                return;
            }
            
            const requestData = deck.map(ing => ({
                id: ing.id,
                name: ing.name,
                rarity: ing.rarity,
                allergy: ing.allergy,
                isUnlocked: true
            }));
            
            getRecipesBtn.disabled = true;
            getRecipesBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            
            fetch(`${API_BASE}/recipe/getRecipes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayRecipes(data);
                    getRecipesBtn.disabled = false;
                    getRecipesBtn.textContent = '–ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã';
                })
                .catch(error => {
                    recipesContainer.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç–æ–≤: ${error.message}</div>`;
                    recipesSection.classList.add('visible');
                    getRecipesBtn.disabled = false;
                    getRecipesBtn.textContent = '–ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã';
                });
        }

        function displayRecipes(recipes) {
            if (recipes.length === 0) {
                recipesContainer.innerHTML = '<div class="loading">–†–µ—Ü–µ–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            } else {
                recipesContainer.innerHTML = recipes.map(recipe => `
                    <div class="recipe-card">
                        <div class="recipe-name">${recipe.name}</div>
                        <div class="recipe-difficulty ${recipe.difficulty}">${recipe.difficulty}</div>
                        <div class="recipe-description">${recipe.description}</div>
                    </div>
                `).join('');
            }
            recipesSection.classList.add('visible');
        }

        function unlockRandomCard() {
            const unlockBtn = document.getElementById('unlockRandomBtn');
            unlockBtn.disabled = true;
            unlockBtn.textContent = 'üé≤ –û—Ç–∫—Ä—ã—Ç–∏–µ...';
            
            fetch(`${API_BASE}/ingredients/UnlockRandomCard/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    console.log('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
                    loadIngredients();
                    unlockBtn.disabled = false;
                    unlockBtn.textContent = 'üé≤ –û—Ç–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç';
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:', error);
                    alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞: ' + error.message);
                    unlockBtn.disabled = false;
                    unlockBtn.textContent = 'üé≤ –û—Ç–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç';
                });
        }

        const unlockRandomBtn = document.getElementById('unlockRandomBtn');
        unlockRandomBtn.addEventListener('click', unlockRandomCard);

        getRecipesBtn.addEventListener('click', getRecipes);

        initDeck();
        loadIngredients();
    </script>
</body>
</html>

